# qingdao

## 部署


### 系统环境
下述的环境需要先手动在部署机器上进行安装。

 - python 3.6.9
 https://www.python.org/downloads/release/python-369/

 - pip 19.3.1
 https://files.pythonhosted.org/packages/ce/ea/9b445176a65ae4ba22dce1d93e4b5fe182f953df71a145f557cffaffc1bf/pip-19.3.1.tar.gz

### 项目环境
在项目中提供了 makefile 文件来进行项目的部署，makefile 中编写了一些规则来执行项目的部署，其中包含 package, install, run, stop, clean 五条规则。以下是使用 makefile 文件进行项目部署的步骤。

**在能够访问到公网的环境下，克隆项目**

``
git clone https://github.com/Ferrair/qingdao.git
``

**在能够访问到公网的环境下，打包项目**

``
cd $project
``
``
make package
``

package 规则采用 pip 命令在在线的环境中下载项目依赖的离线安装包，并将整个项目打包成 zip 压缩包。在完成 package 命令后，在当前目录下会有一个hongsi_deploy.zip 的压缩包，其中包含打包好的所有项目的代码和依赖安装包.

**将压缩包拷贝至部署环境并解压**

``
unzip hongsi_deploy.zip -d hongsi_deploy
``

**安装项目**

``
make install
``

install 规则采用 pip 命令安装依赖安装包，并依据当前环境修改项目中的配置信息

**项目运行**

``
make run
``

因为需要Python代码需要对Disk进行操作，需要先保证对磁盘有读写的权限。

run 规则以后台运行的方式启动项目，并将项目的日志输出重定向到项目根目录下 model_service.log 文件中，并将项目进程的 pid 保存至 pid.txt 中

**检查项目是否运行**

``
make stat
``


同时在model_service.log看到如下消息

```
 * Serving Flask app "/home/qihang/hongsi_deploy/test/src/model_controller.py"
 * Environment: production
   WARNING: Do not use the development server in a production environment.
   Use a production WSGI server instead.
 * Debug mode: off
 * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)
```


请求`http://127.0.0.1:5000/api/test`可以返回`Ok`


**停止项目运行**

``
make stop
``

**清理项目**

``
make clean
``

# 测试
在上述环境配置完成后，model提供2个接口：



提供模型的一些参数给上游的Storm，返回`window_size`和`block_size`。
``
GET http:ip:port/api/load_model_config
``

进行预测，输入特征，返回预测结果
``
POST http:ip:port/api/predict
``

预测接口的请求Body如下，采用Json格式，features字段为计算后的所有特征：
```json
{
	"time": 1583656561404,
	"batch": "Batch",
	"index": 600,
	"stage": "produce",
	"brand": "Txy###",
	"features": [ 
		4.00000000e-02,  3.98239360e-01,  1.95438740e+01, -4.26689180e+01,
        1.42438420e+02,  1.42011400e+02,  1.27433800e+02,  1.26944320e+02,
        2.20000000e-02,  4.00314180e-01,  1.95678900e+01, -3.56432480e+01,
        1.42341300e+02,  1.41851240e+02,  1.27317040e+02,  1.26792520e+02,
        1.60000000e-02,  4.00900340e-01,  1.95611000e+01, -3.98543080e+01,
        1.42226820e+02,  1.41756500e+02,  1.27184420e+02,  1.26713540e+02,
        3.20000000e-02,  4.00420840e-01,  1.95303160e+01, -4.44327740e+01,
        1.42097260e+02,  1.41770300e+02,  1.27044720e+02,  1.26721000e+02,
        6.20000000e-02,  4.01439360e-01,  1.95283900e+01, -3.64927980e+01,
        1.41986600e+02,  1.41890240e+02,  1.26920100e+02,  1.26814320e+02,
        1.04000000e-01,  3.99864780e-01,  1.95654040e+01, -4.57028220e+01,
        1.41893880e+02,  1.42086360e+02,  1.26821100e+02,  1.26987420e+02,
        1.04000000e-01,  3.99801820e-01,  1.94796240e+01, -3.90923340e+01,
        1.41858880e+02,  1.42298500e+02,  1.26784960e+02,  1.27150620e+02,
        1.16000000e-01,  3.99197580e-01,  1.94531160e+01, -4.24953600e+01,
        1.41905760e+02,  1.42423480e+02,  1.26821660e+02,  1.27232440e+02,
        9.00000000e-02,  3.99545200e-01,  1.94468120e+01, -4.39252540e+01,
        1.42024120e+02,  1.42506420e+02,  1.26903640e+02,  1.27260700e+02,
        7.20000000e-02,  3.99602620e-01,  1.93975980e+01, -3.75958380e+01,
        1.42149240e+02,  1.42465800e+02,  1.26981940e+02,  1.27210120e+02,
        1.78885438e-02,  4.38349799e-04,  1.16329044e-02,  4.09847062e+00,
        1.94820327e-02,  4.85078550e-02,  2.40912432e-02,  5.96083350e-02,
        1.60000000e-02,  5.02213339e-04,  1.00370793e-02,  1.09258874e+00,
        3.48131010e-02,  3.93037708e-02,  3.90265858e-02,  3.50101928e-02,
        4.89897949e-03,  5.31631709e-04,  1.50673156e-03,  3.22925351e+00,
        3.62768466e-02,  1.60882566e-02,  4.05477200e-02,  9.88364305e-03,
        7.48331477e-03,  8.56434475e-04,  2.39754196e-02,  2.13473509e+00,
        3.43921852e-02,  1.39202011e-02,  3.86107964e-02,  1.02547550e-02,
        4.00000000e-03,  5.41338817e-04,  1.47831742e-02,  3.35251823e+00,
        3.03703803e-02,  5.14303646e-02,  3.18399121e-02,  3.46827565e-02,
        1.35646600e-02,  1.39746877e-04,  2.05481343e-02,  2.06970437e+00,
        1.97775024e-02,  7.97988371e-02,  2.21840483e-02,  6.72036130e-02,
        8.00000000e-03,  3.49913009e-04,  2.34071524e-02,  2.16361233e+00,
        3.77857116e-03,  3.45523950e-02,  3.79873663e-03,  2.34644753e-02,
        4.89897949e-03,  2.08376845e-04,  9.59406191e-03,  2.08367935e+00,
        2.39169898e-02,  3.68501506e-02,  1.64234710e-02,  2.21683197e-02,
        1.26491106e-02,  1.07754462e-03,  1.90630799e-02,  1.27528347e+00,
        3.50322937e-02,  8.09157587e-03,  2.42672289e-02,  7.20138875e-03,
        4.00000000e-03,  4.94492857e-04,  3.87171487e-03,  1.60792723e+00,
        3.26717370e-02,  1.56228038e-02,  1.86861018e-02,  9.68305737e-03,
        1.50000000e-01,  1.59245395e+00,  7.81770100e+01, -1.70907550e+02,
        5.69756050e+02,  5.68058550e+02,  5.09738300e+02,  5.07783100e+02,
        8.00000000e-02,  1.60122480e+00,  7.82813300e+01, -1.42965115e+02,
        5.69359600e+02,  5.67404400e+02,  5.09263550e+02,  5.07171500e+02,
        6.50000000e-02,  1.60366670e+00,  7.82444900e+01, -1.59232295e+02,
        5.68907600e+02,  5.67018200e+02,  5.08737550e+02,  5.06848800e+02,
        1.25000000e-01,  1.60205750e+00,  7.81176400e+01, -1.78305290e+02,
        5.68388000e+02,  5.67082050e+02,  5.08178450e+02,  5.06879200e+02,
        2.45000000e-01,  1.60614350e+00,  7.81116700e+01, -1.42231600e+02,
        5.67946300e+02,  5.67563850e+02,  5.07679650e+02,  5.07261250e+02,
        4.25000000e-01,  1.59940910e+00,  7.82720750e+01, -1.83792030e+02,
        5.67573100e+02,  5.68340250e+02,  5.07282150e+02,  5.07949850e+02,
        4.10000000e-01,  1.59928125e+00,  7.79200600e+01, -1.55982055e+02,
        5.67431900e+02,  5.69196150e+02,  5.07136750e+02,  5.08609450e+02,
        4.65000000e-01,  1.59681815e+00,  7.78083100e+01, -1.72505365e+02,
        5.67619500e+02,  5.69699150e+02,  5.07284900e+02,  5.08935400e+02,
        3.65000000e-01,  1.59795355e+00,  7.77914050e+01, -1.76493580e+02,
        5.68091550e+02,  5.70031600e+02,  5.07611950e+02,  5.09047300e+02,
        2.90000000e-01,  1.59800525e+00,  7.75861300e+01, -1.48886510e+02,
        5.68598400e+02,  5.69858400e+02,  5.07928850e+02,  5.08832700e+02,
        6.28894119e-01,  4.75809905e-01, -2.06594188e-01,  7.21971296e-02,
       -2.59533400e-01, -5.20391288e-01, -2.78183358e-01, -1.94694718e-01,
       -3.51562500e-02, -8.15581417e-02,  5.88714577e-01,  1.94136565e-01,
        1.41838418e-01, -2.01564267e-01,  2.34218681e-01, -8.01386513e-02,
       -4.08248290e-01, -2.52725467e-01, -5.67842835e-01, -1.10369090e-01,
       -1.53742429e-02,  7.92229468e-01,  6.53814290e-03,  9.37064632e-01,
       -3.43621597e-01, -4.18755693e-01,  2.47852635e-01,  2.41774044e-01,
        5.42079313e-02, -1.65726952e-01,  2.63611289e-02,  1.09894932e+00,
        1.50000000e+00, -1.22198474e-02,  2.55398156e-01, -3.10626059e-02,
        5.35519525e-03, -1.16723402e-01,  4.81581239e-02, -2.43266844e-01,
       -7.50030820e-01, -1.11534801e-01, -6.01261733e-01, -1.09160304e+00,
        2.55130357e-01,  1.26015071e-01,  2.03238109e-01, -2.01695958e-02,
       -8.43750000e-01,  4.17201589e-02, -1.08287785e-01,  3.79690395e-01,
        1.10290355e+00, -1.25555215e-01,  6.78437636e-01, -5.41472439e-01,
       -4.08248290e-01, -1.78304175e-01,  6.24511867e-01,  3.60493414e-01,
        2.84244151e-01, -2.67070783e-01,  2.33846794e-01, -4.95186347e-01,
       -5.92927061e-01,  2.36119709e-01, -4.20082687e-01,  2.28615547e-01,
        2.48248214e-01, -1.18290985e+00,  1.89163623e-01, -1.39830337e+00,
        1.50000000e+00,  7.77942784e-01, -1.72115003e-01, -5.32751921e-01,
       -9.97860317e-02,  4.55698571e-01, -1.25064633e-01,  1.14846977e+00,
       -1.04687500e+00, -1.33891249e+00, -1.68057453e+00, -1.56168425e+00,
       -1.30898384e+00, -1.17875526e+00, -1.22410075e+00, -1.40312149e+00,
       -1.58105469e+00, -1.60259118e+00, -1.05868046e+00, -1.31987139e+00,
       -1.55756927e+00, -1.71532547e+00, -1.51612553e+00, -1.70103094e+00,
       -1.83333333e+00, -1.12423338e+00, -6.57308988e-01, -9.56558102e-01,
       -1.31836815e+00, -8.76059008e-01, -1.32409667e+00, -7.36428596e-01,
       -1.15306122e+00, -1.53515150e+00, -1.58382781e+00, -1.54134987e+00,
       -1.30879325e+00, -9.77185762e-01, -1.30427082e+00, -2.90718188e-01,
        2.50000000e-01, -1.60145055e+00, -1.23684179e+00, -1.68963107e+00,
       -1.24798515e+00, -1.33059647e+00, -1.29516449e+00, -1.22087674e+00,
       -6.36105860e-01, -1.37422640e+00, -1.16839716e+00, -2.68267018e-01,
       -1.31697330e+00, -1.35841134e+00, -1.30286665e+00, -1.32930118e+00,
       -9.21875000e-01, -7.58107763e-01, -1.29849814e+00, -1.43506621e+00,
       -2.82157830e-01, -1.42853653e+00, -7.04092358e-01, -1.01706563e+00,
       -1.83333333e+00, -1.73008404e+00, -1.23156383e+00, -1.78740076e+00, 
       -1.30190733e+00, -1.22520773e+00, -1.25913884e+00, -1.20288376e+00, 
       -1.43750000e+00, -1.62430790e+00, -1.25623595e+00, -1.54251775e+00, 
       -1.39637760e+00, -2.07572187e-01, -1.38454948e+00,  1.09258336e-01, 
       2.50000000e-01, -7.02681267e-01, -1.32149970e+00, -7.78994099e-01, 
       -1.24957922e+00, -1.27264497e+00, -1.35219873e+00, -2.26050742e-01
    ]
}
```

模型返回结果如下：(相对于之前：增加了`furthers`表示按照该策略调整后出口水分应该达到的值（按照时间排序），`predTime`为模型预测时间，`time`为IoT传过来的采样时间)
```json
{
    "batch": "Batch",
    "brand": "Txy###",
    "deviceStatus": "deviceStatus",
    "furthers": [
        12.739432110568586,
        12.725452490280924,
        12.716008541897914,
        12.697579029848578
    ],
    "predTime": 1583656561404,
    "tempRegion1": 142.42488419332318,
    "tempRegion2": 127.21807466299168,
    "time": 1583656561404,
    "version": "1.1"
}
```