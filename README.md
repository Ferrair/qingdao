# qingdao

## 部署


### 系统环境
下述的环境需要先手动在部署机器上进行安装。

 - python 3.6.9
 https://www.python.org/downloads/release/python-369/

 - pip 19.3.1
 https://files.pythonhosted.org/packages/ce/ea/9b445176a65ae4ba22dce1d93e4b5fe182f953df71a145f557cffaffc1bf/pip-19.3.1.tar.gz

### 项目环境
在项目中提供了 makefile 文件来进行项目的部署，makefile 中编写了一些规则来执行项目的部署，其中包含 package, install, run, stop, clean 五条规则。以下是使用 makefile 文件进行项目部署的步骤。

**在能够访问到公网的环境下，克隆项目**

``
git clone https://github.com/Ferrair/qingdao.git
``

**在能够访问到公网的环境下，打包项目**

``
cd $project
``
``
make package
``

package 规则采用 pip 命令在在线的环境中下载项目依赖的离线安装包，并将整个项目打包成 zip 压缩包。在完成 package 命令后，在当前目录下会有一个hongsi_deploy.zip 的压缩包，其中包含打包好的所有项目的代码和依赖安装包.

**将压缩包拷贝至部署环境并解压**

``
unzip hongsi_deploy.zip -d hongsi_deploy
``

**安装项目**

``
make install
``

install 规则采用 pip 命令安装依赖安装包，并依据当前环境修改项目中的配置信息

**项目运行**

``
make run
``

因为需要Python代码需要对Disk进行操作，需要先保证对磁盘有读写的权限。

run 规则以后台运行的方式启动项目，并将项目的日志输出重定向到项目根目录下 model_service.log 文件中，并将项目进程的 pid 保存至 pid.txt 中

**检查项目是否运行**

``
make stat
``


同时在model_service.log看到如下消息

```
 * Serving Flask app "/home/qihang/hongsi_deploy/test/src/model_controller.py"
 * Environment: production
   WARNING: Do not use the development server in a production environment.
   Use a production WSGI server instead.
 * Debug mode: off
 * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)
```


请求`http://127.0.0.1:5000/api/test`可以返回`Ok`


**停止项目运行**

``
make stop
``

**清理项目**

``
make clean
``

# 测试
在上述环境配置完成后，model提供2个接口：



提供模型的一些参数给上游的Storm，返回`window_size`和`block_size`。
``
GET http:ip:port/api/load_model_config
``

进行预测，输入特征，返回预测结果
``
POST http:ip:port/api/predict
``

预测接口的请求Body如下，采用Json格式，features字段为计算后的所有特征：
```json
{
	"time": 1583656561404,
	"batch": "Batch",
	"index": 600,
	"stage": "produce",
	"brand": "TH####A",
	"features": [-5.03600000e+00,  1.25000000e+01,  3.64095860e-01,  1.88375420e+01,
       -3.69109500e+01,  1.35514000e+02,  1.35515180e+02,  1.20226040e+02,
        1.20383300e+02, -3.00000000e-02,  1.25000000e+01,  3.74998660e-01,
        1.88235680e+01, -3.93740480e+01,  1.36036380e+02,  1.35787040e+02,
        1.21159060e+02,  1.20810820e+02, -1.40000000e-02,  1.25000000e+01,
        3.74002220e-01,  1.88152560e+01, -4.20922380e+01,  1.35877660e+02,
        1.35930680e+02,  1.21000280e+02,  1.20922560e+02, -6.40000000e-02,
        1.25000000e+01,  3.74530660e-01,  1.88546360e+01, -2.82164420e+01,
        1.35783440e+02,  1.35847340e+02,  1.20895980e+02,  1.20796760e+02,
       -5.40000000e-02,  1.25000000e+01,  3.75653980e-01,  1.88747840e+01,
       -1.89109980e+01,  1.35701900e+02,  1.35774180e+02,  1.20779620e+02,
        1.20696820e+02, -9.40000000e-02,  1.25000000e+01,  3.76888560e-01,
        1.88882420e+01, -2.86565200e+01,  1.35618200e+02,  1.35671660e+02,
        1.20665320e+02,  1.20600860e+02, -8.00000000e-02,  1.25000000e+01,
        3.76720420e-01,  1.88262440e+01, -3.57908560e+01,  1.35545480e+02,
        1.35538180e+02,  1.20553300e+02,  1.20493920e+02, -2.00000000e-03,
        1.25000000e+01,  3.77673400e-01,  1.88272760e+01, -3.72086900e+01,
        1.35473360e+02,  1.35625480e+02,  1.20450520e+02,  1.20586000e+02,
        3.00000000e-02,  1.25000000e+01,  3.77917260e-01,  1.88306280e+01,
       -4.27194940e+01,  1.35445780e+02,  1.35972120e+02,  1.20416560e+02,
        1.20932500e+02, -4.00000000e-03,  1.25000000e+01,  3.78121040e-01,
        1.88486580e+01, -4.24748780e+01,  1.35498680e+02,  1.36059280e+02,
        1.20464680e+02,  1.21017760e+02,  6.09434033e+00,  0.00000000e+00,
        1.34171962e-02,  3.83422881e-02,  7.37638891e-01,  7.91168993e-01,
        3.70431113e-01,  1.29180725e+00,  5.77463221e-01,  1.67332005e-02,
        0.00000000e+00,  5.56530425e-04,  1.59717030e-02,  1.05939986e+00,
        4.97610048e-02,  1.96723766e-02,  5.05865041e-02,  1.15189236e-02,
        3.26190129e-02,  0.00000000e+00,  1.34341973e-04,  7.21722828e-03,
        1.52659552e+00,  3.42121382e-02,  4.36875909e-02,  3.37335679e-02,
        3.33587530e-02,  1.01980390e-02,  0.00000000e+00,  2.72160905e-04,
        1.45422317e-02,  5.88316652e+00,  2.13257216e-02,  5.13667052e-02,
        2.91252056e-02,  6.03578860e-02,  1.01980390e-02,  0.00000000e+00,
        1.39184298e-03,  3.64002527e-03,  6.04532577e-01,  2.41327993e-02,
        6.73955488e-03,  3.36483224e-02,  9.71460756e-03,  1.35646600e-02,
        0.00000000e+00,  2.30566594e-04,  6.69441977e-03,  4.25923324e+00,
        1.98989447e-02,  5.03491251e-02,  2.76577222e-02,  4.42372965e-02,
        8.94427191e-03,  0.00000000e+00,  3.41526856e-04,  1.81964069e-02,
        1.64393637e+00,  1.92056658e-02,  8.64647905e-03,  3.10263759e-02,
        6.71666584e-03,  4.26145515e-02,  0.00000000e+00,  3.66519173e-04,
        3.81411379e-03,  1.89091890e+00,  1.68651831e-02,  7.47954918e-02,
        2.17196133e-02,  7.63130919e-02,  1.67332005e-02,  0.00000000e+00,
        1.61081490e-04,  3.52993711e-03,  2.49906726e-01,  5.24305255e-03,
        6.55052792e-02,  6.17433397e-03,  6.39779024e-02,  2.05912603e-02,
        0.00000000e+00,  4.41744390e-04,  9.75748615e-03,  1.32348379e+00,
        2.42887134e-02,  1.04470857e-02,  1.96695094e-02,  1.13014335e-02,
       -1.89050000e+01,  5.00000000e+01,  1.45923550e+00,  7.53594200e+01,
       -1.46967135e+02,  5.42262550e+02,  5.42158100e+02,  4.81172050e+02,
        4.81669200e+02, -1.25000000e-01,  5.00000000e+01,  1.50043970e+00,
        7.52876500e+01, -1.56873715e+02,  5.44152750e+02,  5.43140400e+02,
        4.84644050e+02,  4.83237550e+02, -5.50000000e-02,  5.00000000e+01,
        1.49602350e+00,  7.52602200e+01, -1.68775155e+02,  5.43508100e+02,
        5.43747450e+02,  4.83999000e+02,  4.83717100e+02, -2.65000000e-01,
        5.00000000e+01,  1.49818205e+00,  7.54220200e+01, -1.11723815e+02,
        5.43133450e+02,  5.43385400e+02,  4.83586050e+02,  4.83185250e+02,
       -2.15000000e-01,  5.00000000e+01,  1.50244620e+00,  7.54972450e+01,
       -7.50512350e+01,  5.42808000e+02,  5.43100950e+02,  4.83117900e+02,
        4.82790400e+02, -3.85000000e-01,  5.00000000e+01,  1.50741550e+00,
        7.55589950e+01, -1.15662205e+02,  5.42475200e+02,  5.42695400e+02,
        4.82665050e+02,  4.82412100e+02, -3.20000000e-01,  5.00000000e+01,
        1.50704850e+00,  7.52994800e+01, -1.43160915e+02,  5.42179650e+02,
        5.42144350e+02,  4.82209100e+02,  4.81969700e+02, -1.50000000e-02,
        5.00000000e+01,  1.51042210e+00,  7.53135150e+01, -1.46748530e+02,
        5.41893300e+02,  5.42471050e+02,  4.81800500e+02,  4.82312650e+02,
        1.10000000e-01,  5.00000000e+01,  1.51151130e+00,  7.53221450e+01,
       -1.70728145e+02,  5.41779200e+02,  5.43913300e+02,  4.81662600e+02,
        4.83754200e+02, -5.00000000e-03,  5.00000000e+01,  1.51273140e+00,
        7.53959850e+01, -1.70646210e+02,  5.41992350e+02,  5.44242750e+02,
        4.81857900e+02,  4.84077400e+02, -4.08238403e-01,  0.00000000e+00,
       -4.08515814e-01, -4.07179316e-01,  1.64641148e-01, -4.13887620e-01,
       -4.03201942e-01, -4.07977244e-01, -4.04895012e-01,  7.68361249e-01,
        0.00000000e+00, -1.13469846e+00,  1.04154196e+00, -1.35689222e+00,
       -3.36047195e-01,  5.18738573e-01, -3.44950544e-01,  3.26512559e-01,
       -9.12793904e-02,  0.00000000e+00,  3.76567884e-01,  1.49507641e-01,
       -3.22434223e-01,  1.67236729e-01, -7.78771704e-01,  1.29956686e-01,
       -7.23682168e-01, -2.71545418e-01,  0.00000000e+00,  5.90012633e-01,
       -3.07026707e-01, -3.99229202e-01,  4.04532634e-02,  1.30491421e-01,
       -1.60454930e-01,  4.55422994e-02, -2.71545418e-01,  0.00000000e+00,
        7.40341448e-02,  2.75698498e-01,  5.10850518e-01, -5.34561512e-02,
       -1.01947048e+00,  3.83722549e-02, -6.99990928e-01,  7.50030820e-01,
        0.00000000e+00, -1.23950591e+00, -1.27171737e+00,  4.24663442e-01,
       -2.26000096e-01, -2.94189826e-01, -2.49213769e-01, -3.21307539e-01,
        0.00000000e+00,  0.00000000e+00, -4.70173183e-01,  4.65194027e-01,
       -5.13263472e-02,  2.13642007e-01, -9.69896492e-02,  2.33650341e-01,
       -5.28628926e-01,  7.62908726e-02,  0.00000000e+00,  1.43331383e+00,
       -4.69830964e-01, -1.46992599e-01,  3.62246419e-02,  9.33454632e-01,
        1.97160804e-01,  9.25498330e-01,  7.68361249e-01,  0.00000000e+00,
       -2.45479877e-01,  2.58288551e-01,  3.88135839e-01,  4.06903636e-01,
       -9.73431451e-01,  9.36541549e-01, -9.77521886e-01, -6.92728407e-01,
        0.00000000e+00, -8.68881252e-01, -1.66756331e-01,  1.15008209e+00,
        2.23177668e-01, -8.77339304e-01,  8.10470130e-02, -9.37231214e-01,
       -1.83332797e+00, -3.00000000e+00, -1.83271821e+00, -1.82931890e+00,
       -8.91147039e-01, -1.81647474e+00, -1.82669068e+00, -1.83253174e+00,
       -1.83151948e+00, -5.00000000e-01, -3.00000000e+00, -1.92709214e-01,
       -3.11497476e-01,  6.73060573e-02, -9.95304626e-01, -1.29328326e+00,
       -1.05935322e+00, -1.41203419e+00, -1.40745661e+00, -3.00000000e+00,
       -1.54025275e+00, -1.74591077e+00, -1.31595155e+00, -1.21192494e+00,
       -8.82097082e-01, -1.30325738e+00, -7.58900297e-01, -1.04437870e+00,
       -3.00000000e+00, -1.13472500e+00, -1.59956401e+00, -1.21215529e+00,
       -1.36189522e+00, -1.38424719e+00, -1.23297500e+00, -1.43311170e+00,
       -1.04437870e+00, -3.00000000e+00, -1.68094735e+00, -8.19389058e-01,
       -1.09929283e+00, -1.33119158e+00, -4.27455107e-01, -1.29736725e+00,
       -9.05451132e-01, -6.36105860e-01, -3.00000000e+00, -1.30135749e-01,
       -5.46808502e-02, -1.19940426e+00, -1.28799754e+00, -1.32075442e+00,
       -1.36197035e+00, -1.36575786e+00, -1.75000000e+00, -3.00000000e+00,
       -9.30388011e-01, -1.33206231e+00, -1.63304408e+00, -1.45957369e+00,
       -7.76231229e-01, -1.36991278e+00, -1.23871668e+00, -1.44455549e+00,
       -3.00000000e+00,  1.66827015e-01, -1.35027193e+00, -1.21229465e+00,
       -1.18135822e+00, -5.10468573e-01, -1.10994518e+00, -5.19211035e-01,
       -5.00000000e-01, -3.00000000e+00, -1.56719020e+00, -7.87423540e-01,
       -1.46957379e+00, -1.16029241e+00, -3.18865666e-01, -6.81243125e-01,
       -3.08615711e-01, -7.17871129e-01, -3.00000000e+00, -8.26684407e-01,
       -1.47486354e+00, -2.66304342e-01, -1.21664561e+00, -5.04711075e-01,
       -1.31175375e+00, -4.30541316e-01]
}
```

模型返回结果如下：(相对于之前：`predTime`为模型预测时间，`time`为IoT传过来的采样时间)
```json
{
    "batch": "Batch",
    "brand": "TH####A",
    "deviceStatus": "deviceStatus",
    "predTime": 1584242136374,
    "tempRegion1": 135.92840756743323,
    "tempRegion2": 121.09678415064398,
    "time": 1583656561404,
    "version": "1.1"
}
```