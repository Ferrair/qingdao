# qingdao

## 部署


### 系统环境
下述的环境需要先手动在部署机器上进行安装。

 - python 3.6.9
 https://www.python.org/downloads/release/python-369/

 - pip 19.3.1
 https://files.pythonhosted.org/packages/ce/ea/9b445176a65ae4ba22dce1d93e4b5fe182f953df71a145f557cffaffc1bf/pip-19.3.1.tar.gz

### 项目环境
在项目中提供了 makefile 文件来进行项目的部署，makefile 中编写了一些规则来执行项目的部署，其中包含 package, install, run, stop, clean 五条规则。以下是使用 makefile 文件进行项目部署的步骤。

**在能够访问到公网的环境下，克隆项目**

``
git clone https://github.com/Ferrair/qingdao.git
``

**在能够访问到公网的环境下，打包项目**

``
cd $project
``
``
make package
``

package 规则采用 pip 命令在在线的环境中下载项目依赖的离线安装包，并将整个项目打包成 zip 压缩包。在完成 package 命令后，在当前目录下会有一个hongsi_deploy.zip 的压缩包，其中包含打包好的所有项目的代码和依赖安装包.

**将压缩包拷贝至部署环境并解压**

``
unzip hongsi_deploy.zip -d hongsi_deploy
``

**安装项目**

``
make install
``

install 规则采用 pip 命令安装依赖安装包，并依据当前环境修改项目中的配置信息

**项目运行**

``
make run
``

因为需要Python代码需要对Disk进行操作，需要先保证对磁盘有读写的权限。

run 规则以后台运行的方式启动项目，并将项目的日志输出重定向到项目根目录下 model_service.log 文件中，并将项目进程的 pid 保存至 pid.txt 中

**检查项目是否运行**

``
make stat
``


同时在model_service.log看到如下消息

```
 * Serving Flask app "/home/qihang/hongsi_deploy/test/src/model_controller.py"
 * Environment: production
   WARNING: Do not use the development server in a production environment.
   Use a production WSGI server instead.
 * Debug mode: off
 * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)
```


请求`http://127.0.0.1:5000/api/test`可以返回`Ok`


**停止项目运行**

``
make stop
``

**清理项目**

``
make clean
``

# 测试
在上述环境配置完成后，model提供2个接口：



提供模型的一些参数给上游的Storm，返回`window_size`和`block_size`。
``
GET http:ip:port/api/load_model_config
``

进行预测，输入特征，返回预测结果
``
POST http:ip:port/api/predict
``

预测接口的请求Body如下，采用Json格式，features字段为计算后的所有特征：
```json
{
	"time": 1583642800790,
	"batch": "Batch",
	"index": 600,
	"stage": "produce",
	"brand": "Txy###",
	"features": [-10.66, 0.39206925, 19.098808, -36.15824, 131.63051, 133.51778, 118.7552, 119.04407, -10.66, 0.39383915, 19.099194, -37.264477, 132.0924, 133.49115, 118.55514, 118.93565, -10.66, 0.3963667, 19.133228, -38.763573, 132.57906, 133.69589, 118.27974, 118.8432, -10.66, 0.39703304, 19.107489, -37.391235, 133.07523, 133.90503, 117.94936, 118.76231, -10.66, 0.39786786, 19.094013, -35.941883, 133.56038, 134.05118, 117.59236, 118.691666, -10.66, 0.39939636, 19.062672, -34.630337, 134.01836, 134.17302, 117.19975, 118.602905, -10.666, 0.40037888, 19.088732, -35.74779, 134.39261, 134.24849, 116.83667, 118.51697, -10.55, 0.40045357, 19.123613, -35.63491, 134.67819, 134.30574, 116.51182, 118.49296, -9.302, 0.3988742, 19.124208, -42.722572, 134.85672, 134.3346, 116.25188, 118.701584, -6.8300004, 0.4000845, 19.064852, -40.963707, 134.94276, 134.35397, 116.07754, 118.907616, 0.0, 9.909524E-4, 0.005293475, 0.7188152, 0.1315298, 0.02676416, 0.046554346, 0.027109152, 0.0, 6.2089483E-4, 0.009894203, 2.8459535, 0.12819256, 0.040204283, 0.070343845, 0.025125211, 0.0, 2.8396706E-4, 0.0022227776, 0.52456665, 0.1287734, 0.06779585, 0.08736403, 0.019596366, 0.0, 3.752615E-4, 0.011152905, 1.4813627, 0.1374887, 0.041090038, 0.098863475, 0.02645042, 0.0, 4.9945846E-4, 0.006310889, 2.7396812, 0.13827723, 0.031617932, 0.11537775, 0.024372172, 0.0, 6.814348E-4, 0.0068401746, 1.2163284, 0.1303151, 0.031599987, 0.11179586, 0.029723056, 0.0048990916, 3.2118335E-4, 0.014426708, 2.0171814, 0.096638635, 0.016574742, 0.11105239, 0.030281847, 0.11099551, 1.6708438E-4, 0.015382019, 1.5862901, 0.063083865, 0.011247439, 0.07831125, 0.031868488, 0.69528097, 4.975186E-4, 0.028196104, 1.543588, 0.03705638, 0.0046919375, 0.070778504, 0.06943136, 0.6737956, 2.1858513E-4, 0.007953081, 2.5311265, 0.015431383, 0.008256223, 0.027110083, 0.057104584, -42.64, 1.5682645, 76.3953, -144.66898, 526.5206, 534.0703, 475.02264, 476.1786, -42.64, 1.5749222, 76.392685, -148.9461, 528.3684, 533.93396, 474.22504, 475.73944, -42.64, 1.5853348, 76.535446, -154.51929, 530.30115, 534.76764, 473.14124, 475.3768, -42.64, 1.5884212, 76.42658, -148.29437, 532.3047, 535.61816, 471.80563, 475.0486, -42.64, 1.5919187, 76.37199, -143.65875, 534.24316, 536.20776, 470.3845, 474.76788, -42.64, 1.5979193, 76.24403, -139.36461, 536.07086, 536.6953, 468.79672, 474.41388, -42.665, 1.6015661, 76.35572, -142.97452, 537.56146, 536.9899, 467.3663, 474.07483, -42.239998, 1.6019045, 76.4914, -141.30887, 538.71655, 537.2248, 466.0445, 473.96274, -37.24, 1.5949674, 76.50126, -170.33337, 539.4325, 537.33984, 465.00134, 474.82532, -27.285002, 1.6004428, 76.25469, -161.51086, 539.77325, 537.41565, 464.30408, 475.63385, 0.0, 0.048462816, 0.007904123, 0.14336412, 0.023206515, 0.060885187, -0.09110157, -0.24236794, 0.0, 1.2359138, 0.9613833, 0.016929688, 0.020149797, 0.7995928, -0.1348005, 0.33846745, 0.0, 0.0045360937, -0.024377158, 0.38232008, 0.20252457, 0.31282642, -0.389934, -0.40848187, 0.0, 0.4294387, 0.3186681, 0.29360768, -0.058277857, 0.15193272, -0.22610694, 0.046623476, 0.0, -0.7939798, 0.43393943, 0.12819219, -0.022033619, -0.27061477, -0.24284436, -0.101420134, 0.0, 0.35877544, 0.021580523, -0.900001, 0.06575684, -0.217593, 0.033925332, -0.21713984, 0.408482, 0.9681017, 0.0221434, -0.1763249, 0.17580116, 0.32344693, -0.19991882, -0.35219967, 0.67659354, -1.0746377, 0.3473786, -1.0651916, -0.119579785, -0.41847906, -0.040318374, 0.28005385, 0.00820059, -0.14462836, 0.023143977, -0.6694104, -0.35790348, -0.51445395, 0.23576653, -0.40218922, -0.107913256, 0.2647892, -0.23026404, -0.704337, -0.31860223, 0.06875526, 0.4436572, -0.12390387, -3.0, -0.80488944, -1.3267293, -0.59660125, -1.3203044, -1.3088963, -1.3216588, -1.0420567, -3.0, -0.15756059, -0.50208926, -1.7417271, -1.2872021, -0.63958764, -1.2788596, -1.0327065, -3.0, -1.5142882, -1.4630518, -0.9334836, -1.3754872, -1.4250458, -1.5101783, -1.8332062, -3.0, -1.7100439, -1.6470735, -1.7554764, -1.3121946, -1.0535269, -1.3203403, -1.3113229, -3.0, -0.646327, -0.9534137, -1.6618406, -1.2931405, -1.0312091, -1.4757146, -1.1854506, -3.0, -1.237797, -1.2140079, -0.7858312, -1.393381, -1.2420754, -1.6466051, -1.7712098, -1.8332059, -0.67220736, -1.717523, -1.7277144, -1.522139, -1.3933207, -1.568677, -1.5859883, -0.948787, -0.42907453, -1.4870738, -0.22913885, -1.2998222, -1.0232104, -1.4925706, -1.7432919, -1.3866687, -1.3719484, -1.5805357, -0.89760137, -1.2416179, -1.221787, -1.3528577, -1.3355267, -1.2770437, -1.3361638, -1.0154358, -0.66670465, -1.2076278, -1.3818988, -1.0943538, -1.2791837]
}
```

模型返回结果如下：(相对于之前：增加了`furtherHumid`表示按照该策略调整后出口水分应该达到的值，`predTime`为模型预测时间，`time`为IoT传过来的采样时间)
```json
{
    "batch": "Batch",
    "brand": "Txy###",
    "deviceStatus": "deviceStatus",
    "furtherHumid": 12.68846484566067,
    "predTime": 1583642800790,
    "tempRegion1": 135.18362940304635,
    "tempRegion2": 120.39852220912333,
    "time": 1583642800790,
    "version": "1.1"
}
```